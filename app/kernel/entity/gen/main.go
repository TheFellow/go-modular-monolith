package main

import (
	"os"
	"strings"
	"text/template"

	"github.com/TheFellow/go-modular-monolith/app/kernel/entity"
)

var tmpl = template.Must(template.New("entity").Funcs(template.FuncMap{
	"lower": strings.ToLower,
}).Parse(`// Code generated by go generate; DO NOT EDIT.

package entity

import (
	"strings"

	"github.com/TheFellow/go-modular-monolith/pkg/errors"
	cedar "github.com/cedar-policy/cedar-go"
)

{{- range . }}

// {{ .Name }} ID Types and Constants

const (
	Type{{ .Name }}   = cedar.EntityType("{{ .Type }}")
	Prefix{{ .Name }} = "{{ .Prefix }}"
)

// {{ .Name }}ID is a strongly-typed ID for {{ .Name }} entities.
type {{ .Name }}ID cedar.EntityUID

// New{{ .Name }}ID generates a new {{ .Name }}ID.
{{- if .DerivedFrom }}
func New{{ .Name }}ID(source {{ .DerivedFrom }}ID) {{ .Name }}ID {
	if source.IsZero() {
		return {{ .Name }}ID(cedar.NewEntityUID(Type{{ .Name }}, cedar.String("")))
	}
	return {{ .Name }}ID(cedar.NewEntityUID(Type{{ .Name }}, cedar.String(Prefix{{ .Name }}+"-"+source.String())))
}
{{- else }}
func New{{ .Name }}ID() {{ .Name }}ID {
	return {{ .Name }}ID(NewID(Type{{ .Name }}, Prefix{{ .Name }}))
}
{{- end }}

// Parse{{ .Name }}ID creates a {{ .Name }}ID from a string.
func Parse{{ .Name }}ID(id string) ({{ .Name }}ID, error) {
	if id == "" {
		return {{ .Name }}ID(cedar.NewEntityUID(Type{{ .Name }}, cedar.String(""))), nil
	}
	if !strings.HasPrefix(id, Prefix{{ .Name }}+"-") {
		return {{ .Name }}ID{}, errors.Invalidf("invalid {{ lower .Name }} id prefix: %s", id)
	}
	return {{ .Name }}ID(cedar.NewEntityUID(Type{{ .Name }}, cedar.String(id))), nil
}

// EntityUID converts to cedar.EntityUID for Cedar API interop.
func (id {{ .Name }}ID) EntityUID() cedar.EntityUID {
	return cedar.EntityUID(id)
}

// String returns the ID portion as a string.
func (id {{ .Name }}ID) String() string {
	return string(cedar.EntityUID(id).ID)
}

// IsZero returns true if the ID is unset.
func (id {{ .Name }}ID) IsZero() bool {
	return cedar.EntityUID(id).ID == ""
}
{{- end }}
`))

func main() {
	f, err := os.Create("entities_gen.go")
	if err != nil {
		panic(err)
	}
	defer f.Close()

	if err := tmpl.Execute(f, entity.Entities); err != nil {
		panic(err)
	}
}
