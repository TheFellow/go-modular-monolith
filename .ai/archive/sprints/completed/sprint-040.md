# Sprint 040: Standardize Code Generation

## Goal

1. Remove `DerivedFrom` from entity ID generation (unnecessary complexity)
2. Standardize all code generation to use `/gen/` subfolder convention with `.go.tpl` template files

## Problem

### DerivedFrom is Unnecessary

The `DerivedFrom` field in entity generation creates a different `New*ID` signature:

```go
// Regular entity
func NewDrinkID() DrinkID {
    return DrinkID(NewID(TypeDrink, PrefixDrink))
}

// DerivedFrom entity (Inventory derives from Ingredient)
func NewInventoryID(source IngredientID) InventoryID {
    // Derives ID from source...
}
```

But each entity type has its own unique prefix (`inv-`, `ing-`, etc.), so there's no collision risk. The derivation adds complexity without benefit.

### Inconsistent Code Generation Patterns

| Location | Template | Folder | Issues |
|----------|----------|--------|--------|
| `app/kernel/entity/gen/` | Inline string | `/gen/` ✓ | Inline template ✗ |
| `pkg/errors/internal/gen/` | `.go.tpl` files ✓ | `/internal/gen/` | Non-standard path |
| `pkg/dispatcher/` | Embedded `.go.tpl` ✓ | Root | No `/gen/` folder ✗ |
| `pkg/authz/internal/policygen/` | Inline string | `/internal/policygen/` | Inline template ✗, non-standard path |

## Target Convention

```
package/
├── gen/
│   ├── main.go           # Generator code
│   └── template.go.tpl   # Template file(s)
├── types.go              # Source definitions
└── types_gen.go          # Generated output
```

- Generator lives in `/gen/` subfolder
- Templates are `.go.tpl` files (not inline strings)
- Use `//go:embed` to load templates
- Output is `*_gen.go` in parent directory
- `//go:generate go run ./gen` directive in parent

## Changes

### Part 1: Remove DerivedFrom from Entity Generation

#### entities.go

```go
// Before
type EntityDef struct {
    Name        string
    Type        string
    Prefix      string
    DerivedFrom string  // REMOVE
}

var Entities = []EntityDef{
    {Name: "Inventory", Type: "Mixology::Inventory", Prefix: "inv", DerivedFrom: "Ingredient"},  // REMOVE DerivedFrom
}

// After
type EntityDef struct {
    Name   string
    Type   string
    Prefix string
}

var Entities = []EntityDef{
    {Name: "Inventory", Type: "Mixology::Inventory", Prefix: "inv"},
}
```

#### gen/main.go

Remove the `DerivedFrom` conditional in the template - all entities get the same `New*ID()` signature.

### Part 2: Entity Gen - Extract Template to File

#### Before

```go
// app/kernel/entity/gen/main.go
var tmpl = template.Must(template.New("entity").Parse(`// Code generated...
package entity
...
`))
```

#### After

```go
// app/kernel/entity/gen/main.go
package main

import (
    _ "embed"
    // ...
)

//go:embed entities.go.tpl
var tmplText string

func main() {
    tmpl := template.Must(template.New("entity").Funcs(...).Parse(tmplText))
    // ...
}
```

```go
// app/kernel/entity/gen/entities.go.tpl
// Code generated by go generate; DO NOT EDIT.

package entity

import (
    "strings"

    "github.com/TheFellow/go-modular-monolith/pkg/errors"
    cedar "github.com/cedar-policy/cedar-go"
)

{{- range . }}

// {{ .Name }} ID Types and Constants

const (
    Type{{ .Name }}   = cedar.EntityType("{{ .Type }}")
    Prefix{{ .Name }} = "{{ .Prefix }}"
)

// {{ .Name }}ID is a strongly-typed ID for {{ .Name }} entities.
type {{ .Name }}ID cedar.EntityUID

// New{{ .Name }}ID generates a new {{ .Name }}ID.
func New{{ .Name }}ID() {{ .Name }}ID {
    return {{ .Name }}ID(NewID(Type{{ .Name }}, Prefix{{ .Name }}))
}

// Parse{{ .Name }}ID creates a {{ .Name }}ID from a string.
func Parse{{ .Name }}ID(id string) ({{ .Name }}ID, error) {
    if id == "" {
        return {{ .Name }}ID(cedar.NewEntityUID(Type{{ .Name }}, cedar.String(""))), nil
    }
    if !strings.HasPrefix(id, Prefix{{ .Name }}+"-") {
        return {{ .Name }}ID{}, errors.Invalidf("invalid {{ lower .Name }} id prefix: %s", id)
    }
    return {{ .Name }}ID(cedar.NewEntityUID(Type{{ .Name }}, cedar.String(id))), nil
}

// EntityUID converts to cedar.EntityUID for Cedar API interop.
func (id {{ .Name }}ID) EntityUID() cedar.EntityUID {
    return cedar.EntityUID(id)
}

// String returns the ID portion as a string.
func (id {{ .Name }}ID) String() string {
    return string(cedar.EntityUID(id).ID)
}

// IsZero returns true if the ID is unset.
func (id {{ .Name }}ID) IsZero() bool {
    return cedar.EntityUID(id).ID == ""
}
{{- end }}
```

### Part 3: Move Dispatcher Gen to Subfolder

#### Before

```
pkg/dispatcher/
├── gen.go                    # Generator (//go:build ignore)
├── dispatcher_gen.go.tpl     # Template
├── dispatcher.go
└── dispatcher_gen.go
```

#### After

```
pkg/dispatcher/
├── gen/
│   ├── main.go               # Generator
│   └── dispatcher.go.tpl     # Template
├── dispatcher.go             # //go:generate go run ./gen
└── dispatcher_gen.go
```

### Part 4: Move Errors Gen to Standard Path

#### Before

```
pkg/errors/
├── internal/
│   └── gen/
│       ├── main.go
│       ├── errors.go.tpl
│       └── testutil.go.tpl
├── generate.go               # //go:generate go run ./internal/gen
└── errors_gen.go
```

#### After

```
pkg/errors/
├── gen/
│   ├── main.go
│   ├── errors.go.tpl
│   └── testutil.go.tpl
├── errors.go                 # //go:generate go run ./gen
└── errors_gen.go
```

### Part 5: Move Authz Policygen to Standard Path + Extract Template

#### Before

```
pkg/authz/
├── internal/
│   └── policygen/
│       └── main.go           # Inline template
├── generate.go               # //go:generate go run ./internal/policygen
└── policies_gen.go
```

#### After

```
pkg/authz/
├── gen/
│   ├── main.go
│   └── policies.go.tpl       # Extracted template
├── authz.go                  # //go:generate go run ./gen
└── policies_gen.go
```

## Summary of Changes

| Package | Current | After |
|---------|---------|-------|
| `app/kernel/entity` | `/gen/` + inline | `/gen/` + `.go.tpl` |
| `pkg/dispatcher` | root + `.go.tpl` | `/gen/` + `.go.tpl` |
| `pkg/errors` | `/internal/gen/` + `.go.tpl` | `/gen/` + `.go.tpl` |
| `pkg/authz` | `/internal/policygen/` + inline | `/gen/` + `.go.tpl` |

## Tasks

### Phase 1: Entity Generation

- [x] Remove `DerivedFrom` from `EntityDef` struct
- [x] Remove `DerivedFrom` from `Entities` slice (Inventory entry)
- [x] Remove `DerivedFrom` conditional from template
- [x] Extract template to `gen/entities.go.tpl`
- [x] Update `gen/main.go` to use `//go:embed`
- [x] Run `go generate` and verify output

### Phase 2: Dispatcher Generation

- [x] Create `pkg/dispatcher/gen/` folder
- [x] Move `gen.go` → `gen/main.go`
- [x] Move `dispatcher_gen.go.tpl` → `gen/dispatcher.go.tpl`
- [x] Update `//go:generate` directive
- [x] Remove `//go:build ignore` (now in subfolder)
- [x] Run `go generate` and verify output

### Phase 3: Errors Generation

- [x] Move `pkg/errors/internal/gen/` → `pkg/errors/gen/`
- [x] Update `//go:generate` directive
- [x] Update any relative paths in generator
- [x] Run `go generate` and verify output

### Phase 4: Authz Policygen

- [x] Move `pkg/authz/internal/policygen/` → `pkg/authz/gen/`
- [x] Extract inline template to `gen/policies.go.tpl`
- [x] Update `gen/main.go` to use `//go:embed`
- [x] Update `//go:generate` directive
- [x] Run `go generate` and verify output

### Phase 5: Verify

- [x] Run `go generate ./...` from repo root
- [x] Verify all `*_gen.go` files are regenerated correctly
- [x] Run `go test ./...`
- [x] Remove empty `/internal/` folders

## Acceptance Criteria

- [x] `DerivedFrom` removed from entity generation
- [x] All `New*ID()` functions have consistent signatures
- [x] All generators live in `/gen/` subfolders
- [x] All templates are `.go.tpl` files (no inline strings)
- [x] All templates use `//go:embed`
- [x] `go generate ./...` works from repo root
- [x] All tests pass

## Result

```
# Consistent structure across all code generation
app/kernel/entity/
├── gen/
│   ├── main.go
│   └── entities.go.tpl
├── entities.go          # //go:generate go run ./gen
└── entities_gen.go

pkg/dispatcher/
├── gen/
│   ├── main.go
│   └── dispatcher.go.tpl
├── dispatcher.go        # //go:generate go run ./gen
└── dispatcher_gen.go

pkg/errors/
├── gen/
│   ├── main.go
│   ├── errors.go.tpl
│   └── testutil.go.tpl
├── errors.go            # //go:generate go run ./gen
└── errors_gen.go

pkg/authz/
├── gen/
│   ├── main.go
│   └── policies.go.tpl
├── authz.go             # //go:generate go run ./gen
└── policies_gen.go
```
