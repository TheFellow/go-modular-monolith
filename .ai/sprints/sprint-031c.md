# Sprint 031c: Generate Test Helpers for Error Kinds

## Goal

Extend the `pkg/errors` code generator to also produce `pkg/testutil/errors_gen.go` with test assertion helpers for each error kind, simplifying test code.

## Problem

Current test assertions are verbose:

```go
testutil.ErrorIf(t, !errors.IsNotFound(err), "expected NotFound error, got %v", err)
testutil.ErrorIf(t, !errors.IsInvalid(err), "expected invalid error, got %v", err)
```

## Solution

Generate test helpers that wrap the pattern:

```go
testutil.NotFound(t, err)
testutil.Invalid(t, err)
```

## Generated Output

```go
// pkg/testutil/errors_gen.go
// Code generated by errors/internal/gen; DO NOT EDIT.
package testutil

import (
    "testing"

    "github.com/TheFellow/go-modular-monolith/pkg/errors"
)

// Invalid fails the test if err is not an Invalid error.
func Invalid(t testing.TB, err error) {
    t.Helper()
    if !errors.IsInvalid(err) {
        t.Fatalf("expected Invalid error, got %v", err)
    }
}

// NotFound fails the test if err is not a NotFound error.
func NotFound(t testing.TB, err error) {
    t.Helper()
    if !errors.IsNotFound(err) {
        t.Fatalf("expected NotFound error, got %v", err)
    }
}

// Permission fails the test if err is not a Permission error.
func Permission(t testing.TB, err error) {
    t.Helper()
    if !errors.IsPermission(err) {
        t.Fatalf("expected Permission error, got %v", err)
    }
}

// Conflict fails the test if err is not a Conflict error.
func Conflict(t testing.TB, err error) {
    t.Helper()
    if !errors.IsConflict(err) {
        t.Fatalf("expected Conflict error, got %v", err)
    }
}

// Internal fails the test if err is not an Internal error.
func Internal(t testing.TB, err error) {
    t.Helper()
    if !errors.IsInternal(err) {
        t.Fatalf("expected Internal error, got %v", err)
    }
}
```

## Generator Updates

### Add Template

Create `pkg/errors/internal/gen/testutil.go.tpl`:

```go
// Code generated by errors/internal/gen; DO NOT EDIT.
package testutil

import (
    "testing"

    "github.com/TheFellow/go-modular-monolith/pkg/errors"
)

{{ range .Kinds -}}
// {{ .Name }} fails the test if err is not a {{ .Name }} error.
func {{ .Name }}(t testing.TB, err error) {
    t.Helper()
    if !errors.Is{{ .Name }}(err) {
        t.Fatalf("expected {{ .Name }} error, got %v", err)
    }
}

{{ end -}}
```

### Update Generator

Modify `pkg/errors/internal/gen/main.go` to generate both files:

```go
func main() {
    wd, err := os.Getwd()
    must(err)

    data := struct {
        Kinds []perrors.ErrorKind
    }{
        Kinds: perrors.ErrorKinds,
    }

    // Generate errors_gen.go
    generate(wd, "errors.go.tpl", "errors_gen.go", data)

    // Generate testutil/errors_gen.go
    generate(wd, "testutil.go.tpl", "../testutil/errors_gen.go", data)
}

func generate(wd, tplFile, outFile string, data any) {
    tmplBytes, err := os.ReadFile(filepath.Join(wd, "internal", "gen", tplFile))
    must(err)

    tmpl, err := template.New("gen").Parse(string(tmplBytes))
    must(err)

    var buf bytes.Buffer
    must(tmpl.Execute(&buf, data))

    formatted, err := format.Source(buf.Bytes())
    must(err)

    must(os.WriteFile(filepath.Join(wd, outFile), formatted, 0o644))
}
```

## Test Simplifications

### Before

```go
// app/domains/ingredients/delete_cascade_test.go
_, err = fix.Inventory.Get(ctx, ingredient.ID)
testutil.ErrorIf(t, !errors.IsNotFound(err), "expected stock not found, got %v", err)

_, err = fix.Drinks.Get(ctx, drink.ID)
testutil.ErrorIf(t, !errors.IsNotFound(err), "expected drink not found, got %v", err)
```

### After

```go
// app/domains/ingredients/delete_cascade_test.go
_, err = fix.Inventory.Get(ctx, ingredient.ID)
testutil.NotFound(t, err)

_, err = fix.Drinks.Get(ctx, drink.ID)
testutil.NotFound(t, err)
```

### Files to Update

| File | Pattern | Replacement |
|------|---------|-------------|
| `app/domains/ingredients/delete_cascade_test.go` | `testutil.ErrorIf(t, !errors.IsNotFound(err), ...)` | `testutil.NotFound(t, err)` |
| `app/domains/drinks/drinks_test.go` | `testutil.ErrorIf(t, !errors.IsNotFound(err), ...)` | `testutil.NotFound(t, err)` |
| `app/domains/drinks/drinks_test.go` | `testutil.ErrorIf(t, ... !errors.IsInvalid(err), ...)` | `testutil.Invalid(t, err)` |
| `app/domains/ingredients/ingredients_test.go` | `testutil.ErrorIf(t, ... !errors.IsInvalid(err), ...)` | `testutil.Invalid(t, err)` |
| `app/domains/orders/orders_test.go` | `testutil.ErrorIf(t, ... !errors.IsInvalid(err), ...)` | `testutil.Invalid(t, err)` |
| `app/domains/menu/menu_test.go` | `testutil.ErrorIf(t, ... !errors.IsInvalid(err), ...)` | `testutil.Invalid(t, err)` |
| `pkg/errors/errors_test.go` | `testutil.ErrorIf(t, !errors.IsInternal(err), ...)` | `testutil.Internal(t, err)` |

## Tasks

- [ ] Create `pkg/errors/internal/gen/testutil.go.tpl` template
- [ ] Update `pkg/errors/internal/gen/main.go` to generate both files
- [ ] Run `go generate ./pkg/errors/...` to generate `pkg/testutil/errors_gen.go`
- [ ] Update `app/domains/ingredients/delete_cascade_test.go`
- [ ] Update `app/domains/drinks/drinks_test.go`
- [ ] Update `app/domains/ingredients/ingredients_test.go`
- [ ] Update `app/domains/orders/orders_test.go`
- [ ] Update `app/domains/menu/menu_test.go`
- [ ] Update `pkg/errors/errors_test.go`
- [ ] Verify `go build ./...` passes
- [ ] Verify `go test ./...` passes

## Acceptance Criteria

- [ ] `pkg/testutil/errors_gen.go` is generated with helpers for all error kinds
- [ ] Test helpers use `t.Helper()` for proper line reporting
- [ ] Existing tests simplified to use new helpers
- [ ] All tests pass
